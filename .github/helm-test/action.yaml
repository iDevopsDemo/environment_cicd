name: 'Helm Test Action'
description: 'Performs linting and testing of Helm charts'
inputs:
  CHART_DIR:
    description: 'Directory of the Helm chart to test'
    required: true
  GITHUB_TOKEN:
    description: 'GitHub Token'
    required: true
  CONFIG_FILE:
    description: 'Path to Helm charts'
    required: false
    default: './ct.yaml'
  GITVERSION_CONFIG_FILE:
    description: 'Path to GitVersion configuration file'
    required: false
runs:
  using: "composite"
  steps:
    - name: Checkout
      uses: actions/checkout@v5.0.0
      with:
        fetch-depth: 0

    - name: Set up Helm
      uses: azure/setup-helm@v4.3.1

    - uses: actions/setup-python@v6.0.0
      with:
        python-version: '3.x'
        check-latest: true

    - name: Get changed files
      id: changed-files
      uses: tj-actions/changed-files@24d32ffd492484c1d75e0c0b894501ddb9d30d62 # v47

    - name: List all changed files
      env:
        ALL_CHANGED_FILES: ${{ steps.changed-files.outputs.all_changed_files }}
      run: |
        for file in ${ALL_CHANGED_FILES}; do
          echo "$file was changed"
        done
      shell: bash

    - name: Set up chart-testing
      uses: helm/chart-testing-action@v2.8.0

    - name: Determine Version
      id: version_step
      uses: iDevopsDemo/environment_cicd/.github/gitversion@main
      with:
        configFilePath: ${{ inputs.GITVERSION_CONFIG_FILE }}
   
    - name: Update Chart.yaml and values.yaml versions
      run: |
        VERSION=${{ steps.version_step.outputs.fullSemVerDocker }}
        IMAGE_NAME=$(yq e '.image.repository' ${{ inputs.CHART_DIR }}/values.yaml)

        # Update Chart.yaml versions to match the coordinated release
        sed -i "s/^version: .*/version: \"$VERSION\"/" ${{ inputs.CHART_DIR }}/Chart.yaml
        # Update Chart.yaml appVersion to match the Docker image we just built
        sed -i "s/^appVersion: .*/appVersion: \"$VERSION\"/" ${{ inputs.CHART_DIR }}/Chart.yaml

        echo "Updated chart version and appVersion to: $VERSION"

        # Check if a Dockerfile exists to determine if we need to update image tag
        if [ -f "Dockerfile" ]; then
          # Update values.yaml image tag to reference the Docker image we just built
          sed -i "s/tag: .*/tag: \"$VERSION\"/" ${{ inputs.CHART_DIR }}/values.yaml
          echo "Updated chart to reference Docker image: $IMAGE_NAME:$VERSION"
        fi
      shell: bash

    - name: Run chart-testing (list-changed)
      id: list-changed
      run: |
        changed=$(ct list-changed --target-branch ${{ github.event.repository.default_branch }} --config ${{ inputs.CONFIG_FILE }})
        if [[ -n "$changed" ]]; then
          echo "changed=true" >> "$GITHUB_OUTPUT"
        fi
      shell: bash

    - name: Run chart-testing (lint)
      if: steps.list-changed.outputs.changed == 'true'
      run: ct lint --target-branch ${{ github.event.repository.default_branch }} --config ${{ inputs.CONFIG_FILE }}
      shell: bash

    - name: Create kind cluster
      if: steps.list-changed.outputs.changed == 'true'
      uses: helm/kind-action@v1.12.0

    # - name: Login to GitHub Container Registry
    #   uses: docker/login-action@v3
    #   with:
    #     registry: ghcr.io
    #     username: ${{ github.actor }}
    #     password: ${{ inputs.GITHUB_TOKEN }}

    # - name: Load images into kind
    #   if: steps.list-changed.outputs.changed == 'true'
    #   run: |
    #     for chart in $(ct list-changed --target-branch ${{ github.event.repository.default_branch }}); do
    #       image=$(yq e '.image.repository + ":" + .image.tag' "./${chart}/values.yaml")
    #       docker pull "$image"
    #       kubectl cluster-info --context kind-chart-testing
    #       kind load docker-image "$image" --name chart-testing
    #     done
    #   shell: bash

    - name: Run chart-testing (install)
      if: steps.list-changed.outputs.changed == 'true'
      run: ct install --target-branch ${{ github.event.repository.default_branch }} --config ${{ inputs.CONFIG_FILE }}
      shell: bash